# Семантики доставки сообщений

## Введение

В общем виде, любая система обмена сообщениями - это система принимающая от отправителя сообщение и доставляющая его получателю. При этом такая система предоставляет некоторые гарантии доставки, особенно в случае возникновения проблем.

Технически оправданы три семантики доставки:

* `At-most-once delivery` - означает, что сообщение может быть доставлено один раз или не доставлено вовсе, т.е **допускается** потеря сообщения.

* `At-least-once delivery` - означает, что сообщение будет доставлено один или более раз, т.е никогда не будет потеряно. 
  
  Плата за такую надежность - возможное появление дублей доставляемого сообщения, так как при ошибке доставки сообщения будут предприняты повторные отправки.

* `Exactly-once delivery` - гарантированная доставка сообщения строго один раз. 
  
    Вариант, который каждый представляет у себя в голове, когда заходит речь о системе обмена сообщениями.

## Разбор

Система отправляет сообщение, при получении происходит непредвиденная ситуация и получатель на некоторое время выходит из строя. 

### Доставка at-most-once

При выборе семантики `at-most-once` сообщение теряется, так как оно не было обработано.

Грубо говоря, в таком случае нет никаких гарантий доставки - оно либо будет доставлено, либо нет. Это чистый `fire-and-foget`.

Однако это совсем не означает, что такая семантика доставки бесполезна. Для примера использования можно представить датчик дома, который публикует данные о температуре в комнате, если мы потеряем данные за последние полторы минуты о темературе в комнате - это вполне допустимая погрешность работы.

Это как известная шутка-анекдот про [UDP](https://ru.wikipedia.org/wiki/UDP)-протокол:

> Я знаю отличную шутку про UDP, но не факт, что она до вас дойдет. 

### Доставка at-least-once

В большинстве случаев нас такие гарантии не устраивают, поэтому при получении сообщения получатель должен отправить какое-то подтверждение того, что сообщение получено. Нет подтверждения - предпринимаются попытки отправить сообщение еще раз.

В случае, если подтверждение теряется или не успевает во время прийти от получателя, отправитель может отправить сообщение несколько раз и несколько раз оно будет обработано, т.е возможно появление дублей сообщения.

Например, получатель был занят обработкой полученного сообщения и не успел во время отправить подтверждение получения. 

В таком случае он обработает первое сообщение, отправит подтверждение, но отправитель-то уже посчитал, что сообщение не доставлено и снова повторил отправку уже второго сообщения-дубля!

После чего получил запоздалое подтверждение по первому и успокоился. Но получателю уже второе сообщение-дубль отправлено и по сути будет доставлено и обработано два одинаковых сообщения. 
 
Либо мы можем перенаправить сообщение на другой получатель и, если первый получатель все же не умер, мы также обработаем сообщение два раза.

Это и есть поведение при `at-least-once` доставке.

![Модель памяти](../images/at-least-once.jpg)

> Например, на [Apache Kafka](./kafka/intro.md) реализован механизм кольцевого буфера, когда сообщения хранятся некоторый промежуток времени и только потом удаляются.

Ну и самый сложный в реализации вариант - `exactly-once` доставка.

### Доставка exactly-once

В таком случае просто повторить доставку или перенаправить на другой обработчик нельзя, как в случаях, описанных выше.

Нужно будет уже как-то маркировать сообщения при отправке и проверять их при получении, чтобы избежать дубликатов. А это уже потребует некоторую синхронизацию отправителя и получателя, что негативно скажется на общей производительности. Либо реализовать обходное решение на уровне бизнес-логики, т.е возложить на получателя задачу отсеивания дубликатов.

Реализация `exactly-once` дается дорого - ценой масштабирования, производительности, низкой связанности или же усложнением бизнес-логики.

Из-за высокой цены реализации стоит дважды подумать о реальной необходимости использования `exactly-once`.

## Полезные ссылки

1. [Гарантии доставки](http://bavadim.me/programming/2015/09/05/ExaclyOnce.html)
2. [Exactly-Once Delivery May Not Be What You Want](http://brooker.co.za/blog/2014/11/15/exactly-once.html)
3. [You Cannot Have Exactly-Once Delivery](https://bravenewgeek.com/you-cannot-have-exactly-once-delivery/)

